
name: "Deploy app to k8s cluster"
on:
  push:
    # run on push to master
    branches:
      - main
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    
    - name: Build the stack
      run: docker-compose up -d

    - name: Test
      #run: docker network inspect banque_misr_devops_engineer_exercise_default --network container:azure-vote-front
      #run: docker run jwilder/dockerize -wait http://172.18.0.2:8080/healthcheck -timeout 120s -wait-retry-interval 5s
      run: curl localhost:8080
      #run: curl -s localhost:8080 | grep 'Azure Voting App'

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Deploy to AKS
      run: |
        az account set --subscription ${{ secrets.SUBSCRIPTION_ID }}
        az aks get-credentials --resource-group RSG-DEV-REXP-CU --name dev-cluster
        kubectl get namespace -oname | grep "namespace/vote-app" \
            || kubectl create namespace vote-app
        kubectl apply -f kubernetes -n vote-app
        

    
